<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#a9384a">
    <meta name="referrer" content="no-referrer">
    <meta name="description" name="The personal website of Maurice Frank. Information about my work, music and services.">


    
    
    <link rel="stylesheet" href="https://morris-frank.dev/sass/main.4cadd518082a40d8a60c738246c38bdb05c2a7a8640b965ea33a7ea1408b32a9.css">
    <link rel="shortcut icon" type="image/png" href="/icon.png"/>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <title> A serverless captcha for static sites - Morris-Frank </title>
</head>

<body>
    <nav class="center">
        <h1>
            <a href="https://morris-frank.dev">Morris-Frank</a>
        </h1>
        <a href="https://morris-frank.dev/blog">blog</a>
        <a href="https://morris-frank.dev/services">services</a>
        <a href="https://morris-frank.dev/work">work</a>
        <a href="https://morris-frank.dev/music">music</a>
        <a href="https://morris-frank.dev/media">media</a>
        <a href="https://raw.githubusercontent.com/morris-frank/resume/master/Frank_cv.pdf">cv</a>
    </nav>

    <main class="center">
<h2>A serverless captcha for static sites</h2>



<hr/>


<div class="tags">
  
    
    <span>Webdesign</span>
  
</div>


<p>In a recent web-design project we decided that we want to prevent spam and other leakage of information by hiding away that content (e.g. the mail-address) behind a <a href="https://en.wikipedia.org/wiki/CAPTCHA">CAPTCHA</a>. Now that web-site up until that point was a completly static site (build with <a href="https://gohugo.io/">Hugo</a>) even lacking any scripting. As I am a staunch defender of keeping static content static, I wanted to absolutely avoid having to admister a server and maybe even porting this simple site to some for of dynamic CMS.</p>
<p>It might not be obvious why using one of the classic CAPTCHAs (hCaptcha, recaptcha) necessitates a server. The CAPTCHA is a little JS widget which will pose the turing-test question to the user and will communicate with the provider (hCaptcha, Google). The provider server-side will check the answer, and send an approve / dis-approve message back to the site where we can wait for it with a JS script. Now the hidden content should appear, but this content not be contained in the site code yet, otherwise it could be read out. Therefore we need a <em>&ldquo;server&rdquo;</em> that we will send the response token from the CAPTCHA to, then will certify the response with the CAPTCHA provider and only then respond with the hidden content which we at that point can insert into the site.</p>
<p>Because I know nothing about <em>serverless</em> servers and this seemed like the perfect contained λ like function I implemented it with AWS Lambda and Python. This setup has three parts:</p>
<ol>
<li>The lambda function, which takes in a receives a CAPTCHA response token and in case of success returns the hidden content</li>
<li>The CAPTCHA widget in the site</li>
<li>A script that sends the token from the widget to out λ-function, waits for the answer and replaces the widget with the hidden content</li>
</ol>
<center class="box">
<i>Here is a little test with one captcha and two little secrets:</i>
<div class="secret-email">
    <div class="h-captcha" data-sitekey="149a0595-ac45-40e7-8587-c4d78364e156" data-callback="onSuccessfullCaptcha"></div>
    ……@morris-frank.dev
</div>
<div class="secret-secret">
    To see the message use the captcha.
</div>
</center>
<h3 id="the-λ-function">The λ-function</h3>
<p>Now I thought this kind of code lends itself to Node.js and actually implemented a version of the lambda-function in Node which was pretty convoluted, slow and ugly (I&rsquo;m not a Node/JS programmer). Turns out AWS Lambda Python enviroment are <a href="https://medium.com/the-theam-journey/benchmarking-aws-lambda-runtimes-in-2019-part-ii-50e796d3d11b">acutally faster</a> and the code is way simpler. Our function has to communicate to another server, but this happens not asynchronously (on the lambda server), therefore linear Python code is nice and fine.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span><span class="p">,</span> <span class="n">request</span>

<span class="n">VERIFY_URL</span> <span class="o">=</span> <span class="s2">&#34;https://hcaptcha.com/siteverify&#34;</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&#34;0x0000000000000000000000000000000000000000&#34;</span>
<span class="n">SECRETS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;my-secret-mail@example.org&#34;</span><span class="p">,</span>
    <span class="s2">&#34;another-key&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;this&#34;</span><span class="p">:</span> <span class="s2">&#34;could&#34;</span><span class="p">,</span> <span class="s2">&#34;also&#34;</span><span class="p">:</span> <span class="s2">&#34;be an dictionary&#34;</span><span class="p">}</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&#34;headers&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">or</span> <span class="s2">&#34;response&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&#34;headers&#34;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;statusCode&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&#34;secrets&#34;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&#34;headers&#34;</span><span class="p">][</span><span class="s2">&#34;response&#34;</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s2">&#34;secret&#34;</span><span class="p">:</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="s2">&#34;response&#34;</span><span class="p">:</span> <span class="n">response</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">VERIFY_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf8&#34;</span><span class="p">))[</span><span class="s2">&#34;success&#34;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;statusCode&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&#34;secrets&#34;</span><span class="p">:</span> <span class="n">SECRETS</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;statusCode&#34;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&#34;secrets&#34;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
</code></pre></div><script src="https://hcaptcha.com/1/api.js" async defer></script>
<script>
var captcha_lambda_endpoint = "https://nxmko95l3k.execute-api.eu-central-1.amazonaws.com/morrisfrank";
var replaceSecrets = function (secrets) {
    for (const key in secrets) {
        for (const root of document.getElementsByClassName("secret-" + key)){
            root.innerHTML = secrets[key];
        }
    }
}
var onSuccessfullCaptcha = function (token) {
    const XHR = new XMLHttpRequest();
    let data = 'response=' + encodeURIComponent(token);
    XHR.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            let secrets = JSON.parse(this.responseText);
            replaceSecrets(secrets);
        }
    };
    XHR.open('POST', captcha_lambda_endpoint);
    XHR.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
    XHR.send( data );
}
</script>

    </main>

    <footer>
        <div class="center box flex">
            <div>
                <h2>Contact</h2>
                <p>Maurice Frank</p>
                <p class="icon-mail">firstname.lastname @ posteo de</p>
                <p class="icon-code"><a href="https://github.com/morris-frank/morris-frank.dev">source code (MIT)</a></p>
            </div>
            <div>
                <h2>Links</h2>
                <p><a class="icon-github" href="https://github.com/morris-frank">GitHub</a></p>
                <p><a class="icon-insta" href="https://instagram.com/morris_frank_">Instagram</a></p>
                <p><a class="icon-soundcloud" href="https://soundcloud.com/morris-frank/">SoundCloud</a></p>
                <p><a class="icon-twitter" href="https://twitter.com/morris_frank_/">Twitter</a></p>
            </div>
            <div>
                <h2>Privacy statement</h2>
                <p>I don't collect any data from you. Neither do I want any data. So don't send me any!</p>
            </div>
        </div>
    </footer>
</body>
</html>
